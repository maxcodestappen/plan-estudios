<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Abogacía UCC — Malla Curricular 2019</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#080c14;--surface:#0d1220;--border:#1a2540;
  --text:#c8d8f0;--muted:#4a6080;--dim:#2a3a55;
  --nocursada-bg:#0d1220;--nocursada-border:#1a2540;--nocursada-text:#3a5070;
  --cursable-bg:#0e1e30;--cursable-border:#2a4a7a;--cursable-text:#8ab8e0;
  --regular-bg:#1a1a08;--regular-border:#7a6020;--regular-text:#e0c060;
  --aprobada-bg:#081808;--aprobada-border:#206030;--aprobada-text:#60d080;
  --accent:#4a8af0;
  --prereq:#e07040;
  --postreq:#40b0e0;
  --card-w:155px;
  --card-h:86px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;min-height:100vh;overflow-x:auto;}

/* ── LOGIN ── */
#login-screen{
  position:fixed;inset:0;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;gap:16px;
}
#login-screen h1{font-family:'Share Tech Mono',monospace;font-size:1.6rem;color:var(--accent);letter-spacing:0.2em;text-transform:uppercase;}
#login-screen p{font-family:'Share Tech Mono',monospace;font-size:0.65rem;color:var(--muted);letter-spacing:0.15em;text-transform:uppercase;}
.google-btn{
  display:flex;align-items:center;gap:10px;padding:10px 22px;margin-top:8px;
  background:#fff;color:#333;border:none;border-radius:6px;cursor:pointer;
  font-family:'Rajdhani',sans-serif;font-size:0.95rem;font-weight:600;
  box-shadow:0 2px 16px rgba(0,0,0,0.5);transition:all 0.15s;
}
.google-btn:hover{transform:translateY(-1px);}
.google-btn img{width:18px;}
.login-error{font-family:'Share Tech Mono',monospace;font-size:0.62rem;color:#e05a5a;}

/* ── LOADING ── */
#loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:998;gap:10px;}
#loading h2{font-family:'Share Tech Mono',monospace;color:var(--accent);font-size:1.1rem;letter-spacing:0.2em;}
#loading p{font-family:'Share Tech Mono',monospace;font-size:0.6rem;color:var(--muted);}
.spinner{width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}

/* ── HEADER ── */
header{
  padding:10px 20px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
  background:rgba(8,12,20,0.95);position:sticky;top:0;z-index:50;backdrop-filter:blur(8px);
}
.h-title{font-family:'Share Tech Mono',monospace;font-size:1rem;color:var(--accent);letter-spacing:0.18em;text-transform:uppercase;}
.h-sub{font-family:'Share Tech Mono',monospace;font-size:0.55rem;color:var(--muted);letter-spacing:0.12em;margin-top:1px;}
.h-right{display:flex;align-items:center;gap:14px;flex-wrap:wrap;}
.stats{display:flex;gap:14px;align-items:center;}
.stat{text-align:center;}
.stat-n{font-family:'Share Tech Mono',monospace;font-size:1.1rem;line-height:1;}
.stat-l{font-family:'Share Tech Mono',monospace;font-size:0.5rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;margin-top:1px;}
.stat.ap .stat-n{color:var(--aprobada-text);}
.stat.rg .stat-n{color:var(--regular-text);}
.stat.rs .stat-n{color:var(--muted);}
.prog-wrap{width:80px;}
.prog-row{display:flex;justify-content:space-between;font-family:'Share Tech Mono',monospace;font-size:0.5rem;color:var(--muted);margin-bottom:3px;}
.prog-bar-bg{height:2px;background:var(--border);border-radius:1px;}
.prog-bar{height:100%;background:var(--accent);border-radius:1px;transition:width 0.4s;}
.user-pill{display:flex;align-items:center;gap:7px;padding:4px 10px 4px 4px;border:1px solid var(--border);border-radius:20px;background:var(--surface);}
.user-pill img{width:22px;height:22px;border-radius:50%;object-fit:cover;}
.user-pill span{font-family:'Share Tech Mono',monospace;font-size:0.6rem;color:var(--muted);}
.logout-btn{background:none;border:1px solid var(--dim);color:var(--muted);font-family:'Share Tech Mono',monospace;font-size:0.52rem;padding:2px 7px;border-radius:3px;cursor:pointer;transition:all 0.12s;}
.logout-btn:hover{background:var(--border);color:var(--text);}
.sync-dot-wrap{display:flex;align-items:center;gap:5px;font-family:'Share Tech Mono',monospace;font-size:0.55rem;}
.sdot{width:5px;height:5px;border-radius:50%;background:currentColor;}
.sync-dot-wrap.syncing{color:var(--regular-text);}
.sync-dot-wrap.syncing .sdot{animation:blink 0.8s infinite;}
.sync-dot-wrap.synced{color:var(--aprobada-text);}
.sync-dot-wrap.error{color:#e05a5a;}

/* ── LEGEND ── */
.legend-bar{
  padding:7px 20px;border-bottom:1px solid var(--border);
  display:flex;gap:18px;align-items:center;flex-wrap:wrap;
  background:rgba(13,18,32,0.9);
}
.leg-item{display:flex;align-items:center;gap:6px;font-family:'Share Tech Mono',monospace;font-size:0.6rem;font-weight:700;color:var(--muted);letter-spacing:0.08em;}
.leg-box{width:13px;height:13px;border-radius:3px;border:1px solid;flex-shrink:0;}
.leg-box.nocursada  {background:var(--nocursada-bg); border-color:var(--nocursada-border);}
.leg-box.cursable   {background:var(--cursable-bg);  border-color:var(--cursable-border);}
.leg-box.regular    {background:var(--regular-bg);   border-color:var(--regular-border);}
.leg-box.aprobada   {background:var(--aprobada-bg);  border-color:var(--aprobada-border);}
.leg-box.hl-prereq  {background:#1a0a04;             border-color:var(--prereq);}
.leg-box.hl-postreq {background:#04121a;             border-color:var(--postreq);}
.legend-hint{font-family:'Share Tech Mono',monospace;font-size:0.57rem;font-weight:700;color:var(--dim);letter-spacing:0.06em;margin-left:auto;}

/* ── LAYOUT ── */
#app{display:none;}
.malla-outer{padding:16px 16px 40px;}

/* YEAR ROW */
.year-row{display:flex;align-items:flex-start;margin-bottom:32px;}

.year-label-col{
  width:72px;flex-shrink:0;
  display:flex;align-items:flex-start;justify-content:flex-end;
  padding-right:12px;border-right:1px solid var(--border);margin-right:14px;
  padding-top:10px;
}
.yn{display:flex;flex-direction:column;align-items:center;gap:4px;}
.yn-num{font-family:'Share Tech Mono',monospace;font-size:1.4rem;color:var(--accent);font-weight:700;letter-spacing:0.08em;line-height:1;}
.yn-txt{font-family:'Share Tech Mono',monospace;font-size:0.52rem;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;text-align:center;white-space:nowrap;}

.year-sems{flex:1;display:flex;flex-direction:column;gap:22px;}
.sem-half{display:flex;flex-wrap:wrap;gap:8px;}

/* ── CARD ── */
.materia{
  width:var(--card-w);
  height:var(--card-h);
  flex-shrink:0;
  border-radius:6px;
  border:1px solid var(--nocursada-border);
  background:var(--nocursada-bg);
  padding:9px 10px 8px;
  cursor:pointer;
  transition:filter 0.15s, transform 0.12s, border-color 0.25s, box-shadow 0.25s, opacity 0.25s;
  user-select:none;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  position:relative;
  overflow:visible;
}
.materia:hover{filter:brightness(1.4);transform:scale(1.04);z-index:100;}
.materia:active{transform:scale(0.97);}

/* dim non-related cards on hover */
.dimmed{opacity:0.22;filter:brightness(0.6);}

/* highlight prereqs (orange) */
.materia.hl-prereq{
  border-color:var(--prereq) !important;
  box-shadow:0 0 0 1px var(--prereq), 0 0 12px rgba(224,112,64,0.4);
  opacity:1 !important;
}
/* highlight postreqs (blue) */
.materia.hl-postreq{
  border-color:var(--postreq) !important;
  box-shadow:0 0 0 1px var(--postreq), 0 0 12px rgba(64,176,224,0.4);
  opacity:1 !important;
}
/* the hovered card itself */
.materia.hl-origin{
  border-color:#fff !important;
  box-shadow:0 0 0 1px #fff, 0 0 16px rgba(255,255,255,0.2);
  opacity:1 !important;
  filter:brightness(1.4) !important;
}

.mat-name{
  font-family:'Rajdhani',sans-serif;
  font-size:0.82rem;
  font-weight:500;
  line-height:1.22;
  color:var(--nocursada-text);
  word-break:break-word;
  hyphens:auto;
  overflow:hidden;
  display:-webkit-box;
  -webkit-line-clamp:3;
  -webkit-box-orient:vertical;
}
.mat-status{
  font-family:'Share Tech Mono',monospace;
  font-size:0.48rem;
  font-weight:700;
  letter-spacing:0.1em;
  text-transform:uppercase;
  flex-shrink:0;
  margin-top:4px;
}

/* card colour states */
.materia.pendiente{border-color:var(--nocursada-border);background:var(--nocursada-bg);}
.materia.pendiente .mat-name  {color:var(--nocursada-text);}
.materia.pendiente .mat-status{color:var(--nocursada-text);opacity:0.5;}

.materia.cursable{border-color:var(--cursable-border);background:var(--cursable-bg);}
.materia.cursable .mat-name  {color:var(--cursable-text);}
.materia.cursable .mat-status{color:var(--cursable-text);opacity:0.85;}

.materia.regular{border-color:var(--regular-border);background:var(--regular-bg);}
.materia.regular .mat-name  {color:var(--regular-text);}
.materia.regular .mat-status{color:var(--regular-text);opacity:0.85;}

.materia.aprobada{border-color:var(--aprobada-border);background:var(--aprobada-bg);}
.materia.aprobada .mat-name  {color:var(--aprobada-text);}
.materia.aprobada .mat-status{color:var(--aprobada-text);opacity:0.85;}

/* ── TOOLTIP ── */
.mat-tooltip{
  display:none;
  position:fixed;
  z-index:9999;
  width:280px;
  background:linear-gradient(145deg,#0d1628,#091020);
  border:1px solid rgba(74,138,240,0.4);
  border-radius:10px;
  overflow:hidden;
  font-family:'Rajdhani',sans-serif;
  pointer-events:none;
  box-shadow:0 8px 32px rgba(0,0,0,0.9), 0 0 0 1px rgba(255,255,255,0.04);
}
.materia:hover .mat-tooltip{display:none;} /* tooltip now handled globally via JS */

.tt-header{
  padding:10px 14px 9px;
  border-bottom:1px solid rgba(255,255,255,0.06);
  background:rgba(74,138,240,0.08);
}
.tt-matname{
  font-size:1rem;
  font-weight:700;
  color:#e8f0ff;
  line-height:1.2;
  margin-bottom:4px;
}
.tt-badge{
  display:inline-flex;align-items:center;gap:5px;
  font-family:'Share Tech Mono',monospace;
  font-size:0.5rem;letter-spacing:0.12em;
  padding:2px 7px;border-radius:20px;font-weight:700;
}
.tt-badge.pendiente {background:rgba(58,80,112,0.4); color:#5a80a8; border:1px solid #2a3a55;}
.tt-badge.cursable  {background:rgba(42,74,122,0.4); color:#8ab8e0; border:1px solid #2a4a7a;}
.tt-badge.regular   {background:rgba(122,96,32,0.35);color:#e0c060; border:1px solid #7a6020;}
.tt-badge.aprobada  {background:rgba(32,96,48,0.35); color:#60d080; border:1px solid #206030;}

.tt-body{padding:10px 14px;}

.tt-section{margin-bottom:10px;}
.tt-section:last-child{margin-bottom:0;}

.tt-section-header{
  display:flex;align-items:center;gap:6px;
  margin-bottom:6px;
}
.tt-section-icon{
  width:16px;height:16px;border-radius:4px;
  display:flex;align-items:center;justify-content:center;
  font-size:9px;flex-shrink:0;font-weight:700;
}
.tt-section-icon.pre {background:rgba(224,112,64,0.2);color:var(--prereq);border:1px solid rgba(224,112,64,0.4);}
.tt-section-icon.post{background:rgba(64,176,224,0.2);color:var(--postreq);border:1px solid rgba(64,176,224,0.4);}
.tt-section-icon.none{background:rgba(74,138,240,0.1);color:var(--accent);border:1px solid rgba(74,138,240,0.2);}

.tt-section-title{
  font-family:'Share Tech Mono',monospace;
  font-size:0.5rem;letter-spacing:0.12em;text-transform:uppercase;
  font-weight:700;
}
.tt-section-title.pre {color:var(--prereq);}
.tt-section-title.post{color:var(--postreq);}
.tt-section-title.none{color:var(--muted);}

.tt-chips{display:flex;flex-wrap:wrap;gap:4px;}
.tt-chip{
  font-family:'Rajdhani',sans-serif;
  font-size:0.72rem;font-weight:500;
  padding:3px 8px;border-radius:4px;
  line-height:1.2;
}
.tt-chip.pre {background:rgba(224,112,64,0.12);color:#f0a880;border:1px solid rgba(224,112,64,0.25);}
.tt-chip.post{background:rgba(64,176,224,0.12);color:#80d0f0;border:1px solid rgba(64,176,224,0.25);}
.tt-chip.none{color:var(--muted);font-style:italic;font-size:0.68rem;padding:3px 0;}

.tt-libre{
  display:flex;align-items:center;gap:5px;
  margin-top:8px;padding-top:8px;
  border-top:1px solid rgba(255,255,255,0.05);
  font-family:'Share Tech Mono',monospace;
  font-size:0.48rem;letter-spacing:0.1em;
  color:var(--regular-text);
}
.tt-libre-star{font-size:10px;}

.tt-divider{height:1px;background:rgba(255,255,255,0.05);margin:8px 0;}
</style>
</head>
<body>

<div id="login-screen">
  <h1>Abogacía · UCC</h1>
  <p>Malla Curricular — Plan 2019</p>
  <button class="google-btn" onclick="loginGoogle()">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg">
    Continuar con Google
  </button>
  <div class="login-error" id="login-error"></div>
</div>

<div id="loading" style="display:none">
  <div class="spinner"></div>
  <h2>CARGANDO</h2>
  <p id="loading-msg">recuperando tu progreso...</p>
</div>

<div id="app">
  <header>
    <div>
      <div class="h-title">Abogacía · UCC</div>
      <div class="h-sub">Malla Curricular · Plan 2019 · FDyCS</div>
    </div>
    <div class="h-right">
      <div class="stats">
        <div class="stat ap"><div class="stat-n" id="cnt-ap">0</div><div class="stat-l">Aprobadas</div></div>
        <div class="stat rg"><div class="stat-n" id="cnt-rg">0</div><div class="stat-l">Regulares</div></div>
        <div class="stat rs"><div class="stat-n" id="cnt-rs">59</div><div class="stat-l">Restantes</div></div>
      </div>
      <div class="prog-wrap">
        <div class="prog-row"><span>Progreso</span><span id="pct">0%</span></div>
        <div class="prog-bar-bg"><div class="prog-bar" id="prog-bar" style="width:0%"></div></div>
      </div>
      <div class="user-pill">
        <img id="user-photo" src="" alt="">
        <span id="user-name"></span>
        <button class="logout-btn" onclick="logoutUser()">SALIR</button>
      </div>
      <div class="sync-dot-wrap synced" id="sync-wrap">
        <span class="sdot"></span><span id="sync-lbl">OK</span>
      </div>
    </div>
  </header>

  <div class="legend-bar">
    <div class="leg-item"><div class="leg-box pendiente"></div>CORRELATIVA PENDIENTE</div>
    <div class="leg-item"><div class="leg-box cursable"></div>PUEDO CURSAR</div>
    <div class="leg-item"><div class="leg-box regular"></div>REGULAR</div>
    <div class="leg-item"><div class="leg-box aprobada"></div>APROBADA</div>
    <div class="leg-item"><div class="leg-box hl-prereq"></div>PRERREQUISITO</div>
    <div class="leg-item"><div class="leg-box hl-postreq"></div>HABILITA</div>
    <div class="legend-hint">CLICK → cicla estado</div>
  </div>

  <div class="malla-outer" id="malla-outer">
    <div id="malla-grid"></div>
  </div>
</div>

<div id="global-tooltip" class="mat-tooltip" style="display:none;"></div>
<script type="module">
import { initializeApp }                     from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
                                             from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyBEr1HUuUYvWHkI8DfoO9KWm8wraqLmZnY",
  authDomain:"plan-abogacia-ucc.firebaseapp.com",
  projectId:"plan-abogacia-ucc",
  storageBucket:"plan-abogacia-ucc.firebasestorage.app",
  messagingSenderId:"292837545501",
  appId:"1:292837545501:web:81afc0868b7c9e482358f4"
};
const fbApp = initializeApp(firebaseConfig);
const auth  = getAuth(fbApp);
const db    = getFirestore(fbApp);
const prov  = new GoogleAuthProvider();

const materias = [
  {id:'10026',name:'Derecho Privado I',                    curso:1,sem:1,corrCursar:[],corrRendir:[]},
  {id:'10027',name:'Derecho Romano',                        curso:1,sem:1,corrCursar:[],corrRendir:[]},
  {id:'10028',name:'Derecho Político',                      curso:1,sem:1,corrCursar:[],corrRendir:[]},
  {id:'10029',name:'Pensamiento Filosófico',                curso:1,sem:1,corrCursar:[],corrRendir:[]},
  {id:'20020',name:'Derecho Privado II',                    curso:1,sem:2,corrCursar:['10026'],corrRendir:['10026']},
  {id:'20021',name:'Derecho Penal I',                       curso:1,sem:2,corrCursar:[],corrRendir:[]},
  {id:'20022',name:'Derechos Humanos',                      curso:1,sem:2,corrCursar:[],corrRendir:[]},
  {id:'20023',name:'Derecho Constitucional',                curso:1,sem:2,corrCursar:['10028'],corrRendir:['10028']},
  {id:'20024',name:'Antropología',                          curso:1,sem:2,corrCursar:['10029'],corrRendir:['10029']},
  {id:'10030',name:'Derecho Privado III',                   curso:2,sem:1,corrCursar:['20020'],corrRendir:['20020']},
  {id:'10031',name:'Derecho Penal II',                      curso:2,sem:1,corrCursar:['20021'],corrRendir:['20021']},
  {id:'10032',name:'Historia del Derecho',                  curso:2,sem:1,corrCursar:[],corrRendir:[]},
  {id:'20025',name:'Der. Pub. Provincial y Municipal',      curso:2,sem:1,corrCursar:['20023'],corrRendir:['20023']},
  {id:'10033',name:'Pensamiento Teológico',                 curso:2,sem:1,corrCursar:['20024'],corrRendir:['20024']},
  {id:'20026',name:'Derecho Privado IV',                    curso:2,sem:2,corrCursar:['10030'],corrRendir:['10030']},
  {id:'20027',name:'Derecho Procesal Civil',                curso:2,sem:2,corrCursar:[],corrRendir:[]},
  {id:'20028',name:'Práctica Profesional I',                curso:2,sem:2,corrCursar:[],corrRendir:[]},
  {id:'20029',name:'Pensamiento Social Cristiano',          curso:2,sem:2,corrCursar:['10033'],corrRendir:['10033']},
  {id:'20030',name:'Seminario Optativo I',                  curso:2,sem:2,corrCursar:[],corrRendir:[]},
  {id:'10034',name:'Derecho Privado V',                     curso:3,sem:1,corrCursar:['20026'],corrRendir:['20026']},
  {id:'10035',name:'Derecho del Trabajo',                   curso:3,sem:1,corrCursar:[],corrRendir:[]},
  {id:'10036',name:'Derecho Procesal Penal',                curso:3,sem:1,corrCursar:['10031'],corrRendir:['10031']},
  {id:'10037',name:'Der. Procesal Constitucional y Conv.',  curso:3,sem:1,corrCursar:['20023'],corrRendir:['20023']},
  {id:'10038',name:'Soluciones Alternativas de Conflictos', curso:3,sem:1,corrCursar:[],corrRendir:[]},
  {id:'10039',name:'Sociología Jurídica',                   curso:3,sem:1,corrCursar:[],corrRendir:[]},
  {id:'20031',name:'Derecho Concursal',                     curso:3,sem:2,corrCursar:['10034'],corrRendir:['10034']},
  {id:'20032',name:'Derecho Privado VI',                    curso:3,sem:2,corrCursar:['20026'],corrRendir:['20026']},
  {id:'20033',name:'Práctica Profesional II',               curso:3,sem:2,corrCursar:['20027'],corrRendir:['20027']},
  {id:'20034',name:'Filosofía del Derecho',                 curso:3,sem:2,corrCursar:[],corrRendir:[]},
  {id:'20035',name:'Derecho de la Seguridad Social',        curso:3,sem:2,corrCursar:[],corrRendir:[]},
  {id:'20036',name:'Seminario de Formación Humana I',       curso:3,sem:2,corrCursar:[],corrRendir:[]},
  {id:'20037',name:'Seminario Optativo II',                 curso:3,sem:2,corrCursar:[],corrRendir:[]},
  {id:'10040',name:'Derecho Privado VII',                   curso:4,sem:1,corrCursar:[],corrRendir:[]},
  {id:'10041',name:'Derecho Privado VIII',                  curso:4,sem:1,corrCursar:['20026'],corrRendir:['20026']},
  {id:'10042',name:'Derecho Internacional Público',         curso:4,sem:1,corrCursar:[],corrRendir:[]},
  {id:'10043',name:'Derecho Administrativo',                curso:4,sem:1,corrCursar:['20025'],corrRendir:['20025']},
  {id:'10044',name:'Seminario de Formación Humana II',      curso:4,sem:1,corrCursar:[],corrRendir:[]},
  {id:'20040',name:'Derecho Procesal Laboral',              curso:4,sem:1,corrCursar:['10035'],corrRendir:['10035']},
  {id:'20038',name:'Derecho Privado IX',                    curso:4,sem:2,corrCursar:['10040'],corrRendir:['10040']},
  {id:'20039',name:'Derecho Procesal Administrativo',       curso:4,sem:2,corrCursar:['10043'],corrRendir:['10043']},
  {id:'20056',name:'Der. de la Niñez y Adolescencia',       curso:4,sem:2,corrCursar:['10040'],corrRendir:['10040']},
  {id:'20041',name:'Derecho Procesal de Familia',           curso:4,sem:2,corrCursar:['10040'],corrRendir:['10040']},
  {id:'20042',name:'Práctica Profesional III',              curso:4,sem:2,corrCursar:['10036'],corrRendir:['10036']},
  {id:'20043',name:'Derecho del Consumidor',                curso:4,sem:2,corrCursar:['20025'],corrRendir:['20025']},
  {id:'20044',name:'Ética y Deontología',                   curso:4,sem:2,corrCursar:[],corrRendir:[]},
  {id:'20045',name:'Seminario Optativo III',                curso:4,sem:2,corrCursar:[],corrRendir:[]},
  {id:'10045',name:'Der. Ambiental y de los Rec. Naturales',curso:5,sem:1,corrCursar:[],corrRendir:[]},
  {id:'10046',name:'Derecho Internacional Privado',         curso:5,sem:1,corrCursar:['20026'],corrRendir:['20026']},
  {id:'10047',name:'Finanzas y Derecho Tributario',         curso:5,sem:1,corrCursar:['20025'],corrRendir:['20025']},
  {id:'10048',name:'Práctica Profesional IV',               curso:5,sem:1,corrCursar:['20033'],corrRendir:['20033']},
  {id:'10049',name:'Derecho Privado X',                     curso:5,sem:1,corrCursar:['20031'],corrRendir:['20031']},
  {id:'10050',name:'Seminario Optativo IV',                 curso:5,sem:1,corrCursar:[],corrRendir:[]},
  {id:'20046',name:'Argumentación Jurídica',                curso:5,sem:2,corrCursar:['20034'],corrRendir:['20034']},
  {id:'20047',name:'Metodología de la Investigación Jur.',  curso:5,sem:2,corrCursar:[],corrRendir:[]},
  {id:'20048',name:'Técnicas de Litigación Oral',           curso:5,sem:2,corrCursar:[],corrRendir:[]},
  {id:'20049',name:'Práctica Profesional Supervisada',      curso:5,sem:2,corrCursar:['20042','20033'],corrRendir:['20042','20033']},
  {id:'20057',name:'Der. de los Medios de Transporte',      curso:5,sem:2,corrCursar:[],corrRendir:[]},
  {id:'20058',name:'Derecho Bursátil y Cambiario',          curso:5,sem:2,corrCursar:['10049'],corrRendir:['10049']},
  {id:'20051',name:'Idioma Extranjero',                     curso:5,sem:2,corrCursar:[],corrRendir:[]},
];

const byYearSem = {};
for(let y=1;y<=5;y++) byYearSem[y]={1:[],2:[]};
materias.forEach(m => byYearSem[m.curso][m.sem].push(m));

const CYCLE  = ['nocursada','regular','aprobada'];
const YEAR_NAMES = {1:'Primer Año',2:'Segundo Año',3:'Tercer Año',4:'Cuarto Año',5:'Quinto Año'};
const LIBRES = new Set(['20024','10030','10033','20026','20029','20031','20032','20034','20036','10043','10044','10045','10046','20044','20049']);

let estados={}, currentUser=null, syncTimeout=null;

function normalise(v){ return (v==='aprobada'||v==='regular') ? v : 'nocursada'; }

function setSyncStatus(cls,txt){
  document.getElementById('sync-wrap').className='sync-dot-wrap '+cls;
  document.getElementById('sync-lbl').textContent=txt;
}

async function loadData(uid){
  try{
    const snap=await getDoc(doc(db,'usuarios',uid));
    if(snap.exists()){
      const raw=snap.data().estados||{};
      Object.keys(raw).forEach(k=>{ estados[k]=normalise(raw[k]); });
    }
    setSyncStatus('synced','OK');
  }catch(e){ setSyncStatus('error','ERR'); }
}

async function saveData(){
  if(!currentUser)return;
  setSyncStatus('syncing','...');
  if(syncTimeout)clearTimeout(syncTimeout);
  syncTimeout=setTimeout(async()=>{
    try{
      await setDoc(doc(db,'usuarios',currentUser.uid),{estados},{merge:true});
      setSyncStatus('synced','OK');
    }catch(e){ setSyncStatus('error','ERR'); }
  },600);
}

function getEstado(id){ return normalise(estados[id]); }

// Returns: 'aprobada' | 'regular' | 'cursable' | 'pendiente'
function displayState(mat){
  const e = getEstado(mat.id);
  if(e === 'aprobada') return 'aprobada';
  if(e === 'regular')  return 'regular';
  if(!mat.corrCursar.length) return 'cursable'; // sin correlativas → siempre cursable
  return mat.corrCursar.every(c=>{ const ce=getEstado(c); return ce==='regular'||ce==='aprobada'; })
    ? 'cursable' : 'pendiente';
}

const STATUS_LABELS = {
  aprobada:  'APROBADA',
  regular:   'REGULAR',
  cursable:  'PUEDO CURSAR',
  pendiente: 'CORRELATIVA PENDIENTE',
};

function cycleEstado(id){
  const cur = getEstado(id);
  const idx = CYCLE.indexOf(cur);
  estados[id] = CYCLE[(idx+1)%CYCLE.length];
  saveData();
  renderAll();
}

window.loginGoogle = async function(){
  document.getElementById('login-error').textContent='';
  try{ await signInWithPopup(auth,prov); }
  catch(e){ document.getElementById('login-error').textContent='Error al iniciar sesión.'; }
};
window.logoutUser = async function(){ await signOut(auth); };

onAuthStateChanged(auth, async user=>{
  if(user){
    currentUser=user;
    document.getElementById('login-screen').style.display='none';
    document.getElementById('loading').style.display='flex';
    document.getElementById('user-photo').src=user.photoURL||'';
    document.getElementById('user-name').textContent=user.displayName?.split(' ')[0]||'';
    await loadData(user.uid);
    renderAll();
    document.getElementById('loading').style.display='none';
    document.getElementById('app').style.display='block';
  }else{
    currentUser=null; estados={};
    document.getElementById('app').style.display='none';
    document.getElementById('loading').style.display='none';
    document.getElementById('login-screen').style.display='flex';
  }
});

function renderAll(){ renderGrid(); renderStats(); setupHover(); }

function renderStats(){
  let ap=0,rg=0;
  materias.forEach(m=>{ const e=getEstado(m.id); if(e==='aprobada')ap++; else if(e==='regular')rg++; });
  document.getElementById('cnt-ap').textContent=ap;
  document.getElementById('cnt-rg').textContent=rg;
  document.getElementById('cnt-rs').textContent=materias.length-ap-rg;
  const pct=Math.round(ap/materias.length*100);
  document.getElementById('pct').textContent=pct+'%';
  document.getElementById('prog-bar').style.width=pct+'%';
}

function getName(id){ const m=materias.find(x=>x.id===id); return m?m.name:id; }

// Full ancestor/descendant chain
function getFullChain(id){
  const prereqs  = new Set();
  const postreqs = new Set();
  function walkBack(cid){
    const mat=materias.find(m=>m.id===cid);
    if(!mat) return;
    mat.corrCursar.forEach(pid=>{ if(!prereqs.has(pid)){ prereqs.add(pid); walkBack(pid); }});
  }
  function walkForward(cid){
    materias.forEach(m=>{
      if(m.corrCursar.includes(cid) && !postreqs.has(m.id)){ postreqs.add(m.id); walkForward(m.id); }
    });
  }
  walkBack(id);
  walkForward(id);
  return { prereqs, postreqs };
}

function buildTooltip(m){
  const ds = displayState(m);
  // direct prereqs and postreqs
  const directPrereqs  = m.corrCursar.map(getName);
  const directPostreqs = materias.filter(x=>x.corrCursar.includes(m.id)).map(x=>x.name);

  function chips(names, cls){
    if(!names.length) return `<span class="tt-chip none">Ninguna</span>`;
    return names.map(n=>`<span class="tt-chip ${cls}">${n}</span>`).join('');
  }

  const libreHTML = LIBRES.has(m.id)
    ? `<div class="tt-libre"><span class="tt-libre-star">★</span>Se puede rendir en condición LIBRE</div>`
    : '';

  return `
    <div class="tt-header">
      <div class="tt-matname">${m.name}</div>
      <span class="tt-badge ${ds}">${STATUS_LABELS[ds]}</span>
    </div>
    <div class="tt-body">
      <div class="tt-section">
        <div class="tt-section-header">
          <div class="tt-section-icon pre">←</div>
          <span class="tt-section-title pre">Necesito tener regular</span>
        </div>
        <div class="tt-chips">${chips(directPrereqs,'pre')}</div>
      </div>
      <div class="tt-divider"></div>
      <div class="tt-section">
        <div class="tt-section-header">
          <div class="tt-section-icon post">→</div>
          <span class="tt-section-title post">Habilita para cursar</span>
        </div>
        <div class="tt-chips">${chips(directPostreqs,'post')}</div>
      </div>
      ${libreHTML}
    </div>`;
}

function renderGrid(){
  let html='';
  for(let y=1;y<=5;y++){
    const s1=byYearSem[y][1];
    const s2=byYearSem[y][2];
    html+=`<div class="year-row" data-year="${y}">
      <div class="year-label-col">
        <div class="yn">
          <span class="yn-num">${y}°</span>
          <span class="yn-txt">${YEAR_NAMES[y]}</span>
        </div>
      </div>
      <div class="year-sems">
        <div class="sem-half">${s1.map(m=>card(m)).join('')}</div>
        <div class="sem-half">${s2.map(m=>card(m)).join('')}</div>
      </div>
    </div>`;
  }
  document.getElementById('malla-grid').innerHTML=html;
}

function card(m){
  const ds=displayState(m);
  return `<div class="materia ${ds}" data-id="${m.id}" onclick="window._cycle('${m.id}')">
    <div class="mat-name">${m.name}</div>
    <div class="mat-status">${STATUS_LABELS[ds]}</div>
  </div>`;
}

window._cycle = id => cycleEstado(id);

// ── HOVER HIGHLIGHT SYSTEM ───────────────────────────────────────────────────

function setupHover(){
  const allCards = document.querySelectorAll('.materia');
  const tt = document.getElementById('global-tooltip');

  function clearHighlights(){
    allCards.forEach(el=>{
      el.classList.remove('hl-prereq','hl-postreq','hl-origin','dimmed');
    });
    tt.style.display = 'none';
  }

  function applyHighlight(id){
    const { prereqs, postreqs } = getFullChain(id);

    allCards.forEach(el=>{
      const eid = el.dataset.id;
      if(eid === id){
        el.classList.add('hl-origin');
      } else if(prereqs.has(eid)){
        el.classList.add('hl-prereq');
      } else if(postreqs.has(eid)){
        el.classList.add('hl-postreq');
      } else {
        el.classList.add('dimmed');
      }
    });
  }

  allCards.forEach(el=>{

    el.addEventListener('mouseenter', e=>{
      applyHighlight(el.dataset.id);
      const m = materias.find(x=>x.id===el.dataset.id);
      if(m){ tt.innerHTML = buildTooltip(m); tt.style.display = 'block'; }
    });

    el.addEventListener('mousemove', e=>{
      const pad = 12;
      let x = e.clientX + 16;
      let y = e.clientY - 10;
      const tw = 280, th = tt.offsetHeight || 220;
      if(x + tw > window.innerWidth - pad)  x = e.clientX - tw - 16;
      if(y + th > window.innerHeight - pad) y = window.innerHeight - th - pad;
      if(y < pad) y = pad;
      tt.style.left = x+'px';
      tt.style.top  = y+'px';
    });

    el.addEventListener('mouseleave', ()=>{
      clearHighlights();
    });
  });
}
</script>
</body>
</html>
